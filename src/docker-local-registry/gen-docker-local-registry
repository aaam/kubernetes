#!/bin/bash
ROCKS=/opt/rocks/bin/rocks
RUNFILE=/opt/rocks/sbin/docker-local-registry
runcmd="docker run -d \
  --restart=always \
  --name registry \
  -v @DOCKER_BASE@/@DOCKER_CERTS_DIR@:/certs \
  -v @DOCKER_BASE@/@DOCKER_REGISTRY_DIR@:/var/lib/registry \
  -e REGISTRY_HTTP_ADDR=0.0.0.0:443 \
  -e REGISTRY_HTTP_TLS_CERTIFICATE=/certs/docker-registry.crt \
  -e REGISTRY_HTTP_TLS_KEY=/certs/docker-registry.key \
  -e REGISTRY_PROXY_REMOTEURL=https://registry-1.docker.io \
  -p @DOCKER_REGISTRY_PORT@:443 \
  registry:2"
BASE=$($ROCKS report host attr localhost attr=DOCKER_BASE)
CERTS=$($ROCKS report host attr localhost attr=DOCKER_CERT_DIR)
REGISTRY=$($ROCKS report host attr localhost attr=DOCKER_REGISTRY_DIR)
PORT=$($ROCKS report host attr localhost attr=DOCKER_REGISTRY_PORT)
if [ ! -f $RUNFILE ]; then
	echo "#!/bin/bash" > $RUNFILE
	echo "### generated by $0 on $(/bin/date)" >> $RUNFILE
	echo $runcmd | sed -e "s#@DOCKER_BASE@#$BASE#g" \
		 -e "s#@DOCKER_CERTS_DIR@#$CERTS#g" \
		 -e "s#@DOCKER_REGISTRY_DIR@#$REGISTRY#g" \
		 -e "s#@DOCKER_REGISTRY_PORT@#$PORT#g"  >> $RUNFILE
	chmod 744 $RUNFILE
fi
